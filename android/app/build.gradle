plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file("local.properties")
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader("UTF-8") { reader ->
        localProperties.load(reader)
    }
}

def flutterVersionCode = localProperties.getProperty("flutter.versionCode") ?: "1"
def flutterVersionName = localProperties.getProperty("flutter.versionName") ?: "1.0"

android {
    namespace "com.zinus.production.smart_production_app"
    compileSdk 36
    ndkVersion "27.0.12077973"

    // ✅ Enable Java 8 features + desugaring
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
        coreLibraryDesugaringEnabled true
    }

    kotlinOptions {
        jvmTarget = "1.8"
    }

    sourceSets {
        main.java.srcDirs += "src/main/kotlin"
    }

    defaultConfig {
        applicationId "com.zinus.production.smart_production_app"
        minSdkVersion 26
        targetSdkVersion 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
        multiDexEnabled true
        setProperty("archivesBaseName", "zinus-production-v$versionName")
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
            minifyEnabled false
            shrinkResources false
        }
        debug {
            // ⚙️ Removed applicationIdSuffix to match google-services.json
            versionNameSuffix "-debug"
            minifyEnabled false
        }
    }

    // (Opsional) Jika muncul error lint di beberapa plugin modern
    lint {
        disable 'InvalidPackage'
        checkReleaseBuilds false
    }
}

flutter {
    source "../../"
}

dependencies {
    // ✅ Multidex untuk app besar
    implementation "androidx.multidex:multidex:2.0.1"

    // ✅ Firebase BoM (Bill of Materials)
    implementation platform("com.google.firebase:firebase-bom:33.1.2")
    implementation "com.google.firebase:firebase-messaging"

    // ✅ Desugaring lib agar kompatibel dengan Java 8+ API
    coreLibraryDesugaring "com.android.tools:desugar_jdk_libs:2.0.4"
}

// ✅ Apply plugin Google Services (Firebase)
apply plugin: "com.google.gms.google-services"

// ✅ Fix dependency task order untuk Flutter 3.24+
tasks.configureEach { task ->
    if (task.name == "extractDeepLinksDebug" || task.name == "extractDeepLinksRelease") {
        task.mustRunAfter tasks.matching { it.name.startsWith("process") && it.name.contains("GoogleServices") }
    }
}
